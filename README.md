# AlienDetective  
Species of maritime fauna all over the world are known to travel great distances accross oceans and seas. The goal of this workflow is to detect these species by calculating sea distances (traveling around land) and geodesic distances (shortest route) from sample locations to the occurrence data gathered from [GBIF](https://www.gbif.org/). This workflow focuses specifically on occurrence data within Europe.  
![logo3](https://github.com/IrisVP/AlienDetective/assets/151626670/21dd7508-bd81-448a-a096-db07bace2515)  

## Input  

The `Input` folder contains the input files required for running the main script `AlienDetective.R.`  

### Required files:  
- **`Species_Location_NIS.csv`**: Contains a `Specieslist` column with the species names. Other columns correspond to sample location names, where `0` means the species is absent and `1` means it is present at that location.  
- **`Coordinates_NIS.csv`**: Contains sample location names (matching those in `Species_location_NIS.csv`) along with their latitude and longitude coordinates.  
*Need to add something about the preparation of these files?*  

### Generated files:  
These files are created by the script if they are not already present in the `Input` folder. Once generated, they are saved in the `Input` folder for reuse in future runs.  
- `rasterized_land_polygons.rds`: Rasterized world map.  
- `cost_matrix.rds`: Matrix indicating the cost values for land and sea cells.  

>‼️**Note:** If any parameters related to generating the above files are changed, please delete the existing files in the `Input` folder so they can be regenerated with updated parameters.  

## Scripts  
The `Scripts` folder contains the following scripts:  

### `AlienDetective.R`  
This is the main script that:  
- Fetches species occurrence data from GBIF.  
- Calculates sea and geodesic distences.  
- Generates plots for all species listed in species file.  

⚠️ This script is computationally intensive, especially when processing many species or species with large GBIF datasets. Running it on a server is recommended.  
- Unix-based operating systems support multi-core processing, which can be adjusted by setting `num_cores <- <number_of_cores>` at the top of the script.  
- Windows OS supports only single-core processing. To avoid errors or crashes, lines enabling parallel execution should be removed or commented out, comments in the script indicate what changes are needed.  

Usage with command-line arguments:  
| **Argument #** | **Description**                   |  
| -------------- | ------------------------          |  
| 1              | Path to species CSV file          |  
| 2              | Path to coordinates CSV file      |  
| 3              | Path to rasterized world map [^1] |  
| 4              | Path to cost matrix [^1]          |  
| 5              | Path to output directory          |  

[^1] When these files don't exist, they will be generated by the script.  

If no arguments are passes, paths can be manually set inside the script.  

Workflow steps of the script:  
1. **Input data** - Reads species and coordinate CSV files. You can optionally subset species by modifying or uncommenting the line: `species_subset <- c("<species>")`.  
2. **Map configuration** - Loads or generates rasterized world map and cost matrix.  
3. **Input coordinate check** - Checks if the input coordinates are located in sea. If not, they are moved to the neasest sea cell.  
4. **Distances calculation** - For each species present in sample locations:  
    - Downloads GBIF occurrences and saves to CSV.  
    - Checks if GBIF points are in the sea, moves them if necessary.  
    - Calculates sea route and geodesic distance to sample location, rounding to the neasest kilometer.  
    - *Plotting of the distances*  

### `functions.R`  
This script contains helper functions used by `AlienDetective.R`:  
- **`fetch_gbif_data`** - Fetches and formats GBIF occurrence data (latitude, longitude, year, month, country, basisOfRecord). Current settings focus on Europe, but can be customized.  
- **`is_on_land`** - Returns `TRUE` if a point (latitude/longitude) lies on land, otherwise `FALSE`.  
- **`move_to_sea`** - Finds the nearest sea cell to a given point and returns new coordinates along with the moved distance (km). Limits how far a point can be moved by using a radius sequence: `for (radius_km in seq(<min>, <max>, <step>))`.  
- **`calculate.distances`** - Calculates both sea-route and geodesic distances.  
- *Plotting functions*.  

### `Compile_presence_absence_matrix.R`  
This script prepares the data in the correct format for `AlienDetective.R`.  
*Is this still needed?*  

## Output  
The `Output` folder contains the result from running `AlienDetective.R`. For each species in species_location CSV, a folder is created containing CSV files with sea and geodesic distances from GBIF occurrences to sample locations.  

## Note about map  
The map does not include inland freshwater bodies, and the coastline may not be fully accurate. To handle points located inside bays, canals, or near coastlines, coordinates are adjusted to the nearest sea cell when necessary. The adjusted coordinates and the moved distance (km) are saved in the output csv file.  
Due to movement limits, points that are located far inland may return `NA` of `Inf` for distance values. If such points need to be included, you can increase the maximum radius in the `move_to_sea` function to suit your needs.  
