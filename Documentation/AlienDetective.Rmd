---
title: "Documentation AlienDetective.R"
author: "Matthijs Gielen"
date: "2025-05-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

This document explains how the script `AlienDetective.R` works and how it should be used.  

# Setup environment  

The script begins by setting up the environment with the following steps:  

- Define the number of cores to be used (for parallelisation on **Unix-based** operating systems). The number of cores must be a positive integer, the script includes a check for this.    
**Note:** This parallel setup is designed and tested for **Unix-based systems** and has not been successfully tested on Windows systems. If you plan to run the script on Windows, it is recommended to remove or comment out this section, as it may not function as expected. 

```{r}
num_cores <- 4

if (!is.numeric(num_cores) || num_cores <= 0 || num_cores != floor(num_cores)) {
  stop("Number of cores must be a positive, natural number!")
}
```

- Set the CRAN mirror for downloading new packages. 
The current script sets a default CRAN mirror, if you desire a local mirror, please replace the link with the correct local link.  

```{r}
options(repos = c(CRAN = "https://cloud.r-project.org"))
```

- Install needed packages, if not already installed.  
**Note** This does not load the packages, as it is better to use explicit namespace [e.g. `raster::extract()` rather than `extract()`] instead of loading all the packages at once.  

```{r}
cat(">>> [INIT] Checking for required packages...\n")
packages <- c("rgbif", "sf", "sp", "gdistance", "geodist", "raster", "fasterize", "ggplot2", "rnaturalearth", "rnaturalearthdata", "dplyr", "spThin", "foreach", "doParallel")
for (package in packages) {
  if(!requireNamespace(package, quietly = TRUE)) {
    install.packages(package)
  }
}
```

- Load the custom functions script `functions.R`.  

```{r}
source("Scripts/functions.R")
```

**Note:** When installation fails for a package because it is "not available for your version of R", try installing the package from source:  

```{r}
install.packages(package, pkgType = "source")
```

---  

# Input  

It is possible to run the script using command-line arguments to define the input files and output directory.  
The order of the command-line arguments:  

| **Position** | **Description**                |
| ------------ | -------------------------------|
| 1            | Path to species CSV file       |
| 2            | Path to coordinates CSV file   |
| 3            | Path to rasterized world map * |
| 4            | Path to cost matrix *          |
| 5            | Path to output directory       |

*: When these files don't exist, they will be generated by the script.  

The code below extracts the command-line arguments and assigns the paths to variables.  

```{r}
cat(">>> [INIT] Reading input data...\n")
args <- commandArgs(trailingOnly = TRUE)
species_location_path <- args[1]
location_coordinates_path <- args[2]
rasterized_path <- args[3]
cost_matrix_path <- args[4]
output_dir <- args[5]
```

When no arguments are provided, there is a backup in the script to set the paths to these predefined paths:  

```{r}
if (length(args) == 0) {
  species_location_path <- file.path("Input", "Species_Location_NIS.csv")
  location_coordinates_path <- file.path("Input", "Coordinates_NIS.csv")
  land_polygons_path <- file.path("Input/land_polygons", "land_polygons.shp")
  rasterized_path <- file.path("Input", "rasterized_land_polygons.rds")
  cost_matrix_path <- file.path("Input", "cost_matrix.rds")
  output_dir <- "Output"
}
```

# Reading species input  

Read species-location presence/absence matrix.  

```{r}
species_location <- read.csv(species_location_path, sep = ";")
```

If there are more than one row per species, remove all but the first row for each species.  

```{r}
species_location <- species_location[!duplicated(species_location[1]),]
```

Read table of coordinates for every location name (ObservatoryID).  

```{r}
location_coordinates <- read.csv(location_coordinates_path, sep = ";")
```

It is possible to select certain species to run the script for.  
Simply replace the ... by the species.  
This can also be used to exclude certain species, by negating the which function.

```{r}
species_subset <- c("...")
species_location <- species_location[which(species_location$Specieslist %in% species_subset),]
```

Define the fields needed for the downloading of the GBIF occurrences.  

```{r}
required_columns <- c("decimalLatitude", "decimalLongitude", "year", "month", "country")
```

